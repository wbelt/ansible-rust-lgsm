---
- hosts: all
  vars:
    rustuser: rustserver
    lgsm_prereqs:
      - curl
      - wget
      - file
      - tar
      - bzip2
      - gzip
      - unzip
      - bsdmainutils
      - python3
      - util-linux
      - ca-certificates
      - binutils
      - bc
      - jq
      - tmux
      - netcat
      - lib32gcc-s1
      - lib32stdc++6
      - steamcmd
      - lib32z1
      - libsdl2-2.0-0:i386

  gather_facts: true
  become: true
  become_user: root
  tasks:
    - name: Rust Server User
      ansible.builtin.user:
        name: "{{ rustuser }}"
        create_home: true
        shell: /bin/bash
      register: usr
    - name: accept steam license
      debconf:
        name: "steam"
        question: "steam/question"
        value: "I AGREE"
        vtype: "select"
    - name: Add i386 arch
      command: dpkg --add-architecture i386
    - name: Install prereqs
      apt:
        name: "{{ lgsm_prereqs }}"
        update_cache: yes
        state: present
    - name: Download lgsm installer
      ansible.builtin.shell: "wget -O linuxgsm.sh https://linuxgsm.sh && chmod +x linuxgsm.sh && bash linuxgsm.sh rustserver"
      args:
        chdir: "{{ usr.home }}"
        creates: rustserver
        executable: /bin/bash       
      become: True
      become_user: "{{ rustuser }}"
    - name: Rust Server install
      shell: "./rustserver auto-install"
      args:
        chdir: "{{ usr.home }}"
        creates: "./serverfiles/server/rustserver/cfg/server.cfg"
        executable: /bin/bash       
      become: True
      become_user: "{{ rustuser }}"
    - name: Rust RCON password
      ansible.builtin.lineinfile:
        path: "{{ usr.home }}/lgsm/config-lgsm/rustserver/secrets-rustserver.cfg"
        regexp: '^rconpassword'
        line: 'rconpassword="{{ rcon_password }}"'
    - name: Rust Cron Monitor
      ansible.builtin.cron:
        name: Rust Server Monitor
        minute: "*/5"
        hour: "*"
        day: "*"
        month: "*"
        weekday: "*"
        job: "{{ usr.home }}/rustserver monitor > /dev/null 2>&1"
        user: "{{ rustuser }}"
    - name: Rust Cron Update
      ansible.builtin.cron:
        name: Rust Server Update
        minute: "*/30"
        hour: "*"
        day: "*"
        month: "*"
        weekday: "*"
        job: "{{ usr.home }}/rustserver update > /dev/null 2>&1"
        user: "{{ rustuser }}"
    - name: Rust Cron Update LGSM
      ansible.builtin.cron:
        name: Rust Server Update LGSM
        minute: "0"
        hour: "0"
        day: "*"
        month: "*"
        weekday: "0"
        job: "{{ usr.home }}/rustserver update-lgsm > /dev/null 2>&1"
        user: "{{ rustuser }}"
